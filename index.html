<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rate Window Visualizer</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; margin: 24px; }
    textarea { width: 100%; max-width: 680px; }
    table { border-collapse: collapse; margin-top: 12px; width: 100%; max-width: 860px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f7f7f7; }
    .ok { color: #0a7b2e; font-weight: 600; }
    .ng { color: #b42318; font-weight: 600; }
    .boundary-hit { background: #fff4e5; }
  </style>
</head>
<body>
<h1>Rate Window Visualizer</h1>
<label>Limit <input id="limit" type="number" value="5" min="1"></label>
<label>Window(s) <input id="window" type="number" value="10" min="1"></label>
<br><br>
<textarea id="events" rows="6">0,1,2,3,4,5,9,10,11</textarea>
<br>
<small>timestamps can be comma, space, or newline separated</small>
<br><br>
<button onclick="applyPreset('normal')">Preset: normal</button>
<button onclick="applyPreset('boundary')">Preset: boundary</button>
<button onclick="applyPreset('burst')">Preset: burst</button>
<button onclick="run()">Simulate</button>
<pre id="out"></pre>
<div id="tableWrap"></div>

<script>
const HELPER_NOTE_TEXT = 'before/after = timestamp lists, not counts';
console.assert(
  HELPER_NOTE_TEXT.includes('timestamp lists') && HELPER_NOTE_TEXT.includes('not counts'),
  'HELPER_NOTE_TEXT must keep the "timestamp lists, not counts" wording contract.'
);

function parseEvents(raw){
  return raw
    .split(/[\s,]+/)
    .map(s => s.trim())
    .filter(Boolean)
    .map(Number)
    .filter(n => !Number.isNaN(n));
}

function applyPreset(name){
  const presets = {
    normal: { limit: 5, window: 10, events: '0,1,2,3,4,5,9,10,11' },
    boundary: { limit: 2, window: 10, events: '0,5,10' },
    burst: { limit: 3, window: 10, events: '0,0,1,1,1,2,2,3' }
  };
  const p = presets[name];
  if(!p) return;
  document.getElementById('limit').value = p.limit;
  document.getElementById('window').value = p.window;
  document.getElementById('events').value = p.events;
  run();
}

function formatList(values){
  return values.length ? values.join(', ') : '-';
}

function run(){
  const L = +document.getElementById('limit').value;
  const W = +document.getElementById('window').value;
  const arr = parseEvents(document.getElementById('events').value);

  const q = [];
  const lines = [];
  const rows = [];

  for(let i = 0; i < arr.length; i += 1){
    const t = arr[i];
    const step = i + 1;
    let excluded = 0;
    while(q.length && t - q[0] >= W){
      q.shift();
      excluded += 1;
    }

    const before = q.slice();
    const ok = q.length < L;
    if(ok) q.push(t);
    const after = q.slice();

    lines.push(`#${step} @ ${t}s => ${ok ? 'ACCEPT' : 'REJECT'} (excluded=${excluded}, before=[${formatList(before)}], after=[${formatList(after)}])`);
    rows.push({
      t,
      excluded,
      before: formatList(before),
      decision: ok ? 'ACCEPT' : 'REJECT',
      after: formatList(after)
    });
  }

  document.getElementById('out').textContent = lines.join('\n');
  renderTable(rows);
}

function renderTable(rows){
  const wrap = document.getElementById('tableWrap');
  if(!rows.length){
    wrap.innerHTML = '<p>No valid timestamps.</p>';
    return;
  }

  const html = `
    <p><small>Legend:</small></p>
    <ul style="margin:0 0 10px 16px;padding:0;font-size:12px;line-height:1.6;">
      <li><span style="background:#fff4e5;padding:2px 6px;border-radius:4px;">boundary-hit row</span> = this step excluded one or more events at the window boundary (<code>t - head >= window</code>)</li>
      <li><span class="ok">ACCEPT</span> = request stayed under limit and was added to in-window queue</li>
      <li><span class="ng">REJECT</span> = in-window queue already reached limit before this request</li>
      <li><code>in-window before / after</code> show timestamp lists (not counts). Example: <code>0, 1, 2</code> means those timestamps are currently inside the active window.</li>
    </ul>
    <p style="margin:0 0 8px 0;font-size:12px;color:#555;">
      Helper note: <code>${HELPER_NOTE_TEXT}</code>.
      Contract check: open DevTools Console and confirm no assertion failed.
    </p>
    <table>
      <thead>
        <tr>
          <th>t (s)</th>
          <th>excluded at boundary</th>
          <th title="${`Timestamps currently in the active window before evaluating this event (${HELPER_NOTE_TEXT})`}">in-window before</th>
          <th>decision</th>
          <th title="${`Timestamps remaining in the active window after this event is evaluated (${HELPER_NOTE_TEXT})`}">in-window after</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr class="${r.excluded > 0 ? 'boundary-hit' : ''}">
            <td>${r.t}</td>
            <td>${r.excluded}</td>
            <td>${r.before || '-'}</td>
            <td class="${r.decision === 'ACCEPT' ? 'ok' : 'ng'}">${r.decision}</td>
            <td>${r.after || '-'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  wrap.innerHTML = html;
}

run();
</script>
</body>
</html>
